#!/usr/bin/env node
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("path"),t=require("fs"),n=require("express"),r=require("mime"),o=require("ws"),c=require("chokidar");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=s(n),u=s(r),a=s(c);function l(e,t,n){for(;n.includes(e);)n=n.replace(e,t);return n}function p(t){return!!t&&""===e.extname(t)}function d(e){return new Promise(((n,r)=>{t.readFile(e,{encoding:null,flag:"r"},((e,t)=>{e&&r(e),t&&n(t)}))}))}function f(e){return new Promise(((n,r)=>{t.readFile(e,{encoding:"utf8",flag:"r"},((e,t)=>{e&&r(e),t&&n(t)}))}))}function h(e){const t=function(e){return l("\\","/",l("\\\\","/",e))}(e),n=/\w+(\/.*)?$/.exec(t),r=n&&n[1]||"/";return"/"===r[r.length-1]?r+"index.html":r}var g;exports.Option=void 0,(g=exports.Option||(exports.Option={})).Input="-i",g.Serve="-s",g.Port="-p",g.Effect="-e";const w={[exports.Option.Input]:p,[exports.Option.Serve]:p,[exports.Option.Port]:function(e){const t=Number(e);return!isNaN(t)&&t>0&&t<1e4},[exports.Option.Effect]:function(t){return!!t&&".js"===e.extname(t)}},v={[exports.Option.Input]:"inputPath",[exports.Option.Serve]:"servedPath",[exports.Option.Port]:"port",[exports.Option.Effect]:"effect"};try{const e=function(e){const[,,...t]=e,n=[...t].reduce(((e,t)=>{const n=e[e.length-1];return n&&n.length<2?n.push(t):e.push([t]),e}),[]),r={};return n.reduce(((e,t)=>{const n=t[0],r=t[1],o=w[n];if(o&&o(r)){e[v[n]]=r}return e}),r)}(process.argv);if(!e.inputPath)throw new Error("No input path given");(function({inputPath:e,servedPath:t,_port:n,effect:r}){try{const t=Number(n)||8e3,r=t+1,c={};c["/_websocket.js"]=function(e){return`const url = 'ws://localhost:${e}'\nconst webSocket = new WebSocket(url)\nwebSocket.addEventListener('open', (event) => {\n    console.log('Live reload: websocket connected')\n    webSocket.addEventListener('message', (event) => {\n        const reload = event.data === 'reload'\n        if (reload) {\n            window.location.reload()\n        }\n    })\n})\n`}(r);const s=i.default(),l=function(e){const t=a.default.watch(e,{ignored:/(^|[\/\\])\../,persistent:!0});return Object.freeze({onUpdate(...e){["add","change","unlink"].forEach((n=>{t.on(n,(t=>{for(const n of e)n(t)}))}))},close(){t.close()}})}(e),p=e=>{const t=function(e){const t=u.default.getType(e);return"text"===t.slice(0,4)||t===u.default.getType("js")||t===u.default.getType("mjs")}(e)?f:d,n=h(e),r=n.includes("index.html");t(e).then((e=>t=>{c[n]=e?function(e){const[t,n,r,o,c,s,i]=e.match(/([^]+)(<body>\n?)(\s*)([^]+)(<\/body>)([^]+)/)||[];return n+r+o+c+o+'<script src="_websocket.js"><\/script>\n'+s+i}(t):t})(r)).catch((e=>{throw new Error(`ERROR reading data from server: ${e}`)}))},g=()=>{O&&O.send("reload")},w=e=>{p(e),g()};let v,x,O;return l.onUpdate(w),Object.freeze({start(){s.get("/*",((e,t)=>{const n="/"===e.url[e.url.length-1]?e.url+"index.html":e.url,r=c[n];var o;t.set("Content-Type",(o=n,u.default.getType(o))),t.send(r)})),v=s.listen(t,(()=>{console.log(`Listening at http://localhost:${t}`)})),x=new o.Server({port:r}),x.on("connection",(e=>{O=e})),x.on("close",(()=>{O=null}))},stop(){v&&v.close()}})}catch(e){throw new Error(`ERROR thrown in CuteServer instance code: ${e}`)}})(e).start()}catch(e){console.log(e)}
